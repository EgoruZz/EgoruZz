name: WakaTime Professional Stats
concurrency:
  group: wakatime-pro-${{ github.ref }}
  cancel-in-progress: false

on:
  schedule:
    - cron: "30 0 * * *"  # 00:30 UTC
  workflow_dispatch:

jobs:
  generate-stats:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Generate Professional Stats
        env:
          WAKATIME_API_KEY: ${{ secrets.WAKATIME_API_KEY }}
        run: |
          pip install requests
          python -c "
          import requests, json
          from datetime import datetime

          # Get comprehensive stats
          url = 'https://wakatime.com/api/v1/users/current/stats/last_7_days'
          headers = {'Authorization': f'Bearer $WAKATIME_API_KEY'}
          response = requests.get(url, headers=headers)
          data = response.json()['data']

          # Prepare data sections
          def prepare_section(items, limit):
              return ''.join([f'- {item[\"name\"]}: {item[\"text\"]} ({item[\"percent\"]}%)\n' for item in items[:limit]])

          # Generate markdown
          stats = f'''## WAKATIME DEVELOPMENT ANALYTICS (7-DAY REPORT)
          **Last Updated**: {datetime.now().strftime('%Y-%m-%d %H:%M UTC')}

          ### SUMMARY
          - **Total Time**: {data['human_readable_total']}
          - **Daily Average**: {data['human_readable_daily_average']}
          - **Best Day**: {data['best_day']['text']} ({data['best_day']['date']})

          ### TIME DISTRIBUTION
          - **Coding**: {data['categories']['coding']['text']} ({data['categories']['coding']['percent']}%)
          - **Building**: {data['categories']['building']['text']} ({data['categories']['building']['percent']}%)
          - **Debugging**: {data['categories']['debugging']['text']} ({data['categories']['debugging']['percent']}%)

          ### LANGUAGES (TOP 7)
          {prepare_section(data['languages'], 7)}

          ### DEVELOPMENT ENVIRONMENT
          **Editors**:
          {prepare_section(data['editors'], 3)}

          **Operating Systems**:
          {prepare_section(data['operating_systems'], 2)}

          ### PROJECTS (TOP 3)
          {prepare_section(data['projects'], 3)}
          '''

          # Save to file
          with open('stats.md', 'w') as f:
              f.write(f'```markdown\n{stats}\n```')

          # Update README
          with open('README.md', 'r') as f:
              content = f.read()

          start = content.find('<!--START_SECTION:waka-->')
          end = content.find('<!--END_SECTION:waka-->')

          if start != -1 and end != -1:
              with open('README.md', 'w') as f:
                  f.write(content[:start] + '<!--START_SECTION:waka-->\n' + open('stats.md').read() + '\n<!--END_SECTION:waka-->' + content[end+len('<!--END_SECTION:waka-->'):])
          "

      - name: Commit changes
        run: |
          git config --global user.name "WakaTime Analytics"
          git config --global user.email "analytics@github.com"
          git add README.md
          git commit -m "ðŸ“ˆ Update professional WakaTime stats"
          git push
