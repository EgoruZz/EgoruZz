name: WakaTime Sync
concurrency:
  group: wakatime-sync-${{ github.ref }}
  cancel-in-progress: false

on:
  schedule:
    - cron: "10 0 * * 1"  # Monday at 00:10 UTC (03:10 MSK)
    - cron: "0 */3 * * *" # Every 3 hours at :00
  workflow_dispatch:
    inputs:
      force-refresh:
        description: 'Force full refresh (ignore cache)'
        required: false
        default: 'false'

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup environment
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc figlet toilet boxes
          sudo npm install -g carbon-now-cli || echo "Carbon-now-cli installation failed"
          # Install Playwright browsers
          npx playwright install chromium
          command -v cowsay >/dev/null 2>&1 || sudo apt-get install -y cowsay
          command -v fortune >/dev/null 2>&1 || sudo apt-get install -y fortune-mod
          command -v lolcat >/dev/null 2>&1 || sudo gem install lolcat || echo "Lolcat not available"

      - name: Fetch and process stats
        id: process-stats
        env:
          WAKATIME_API_KEY: ${{ secrets.WAKATIME_API_KEY }}
        run: |
          # Function for progress bars
          generate_progress_bar() {
            local value=${1:-0}
            local max=${2:-100}
            local size=${3:-20}
            local percentage=$(( value * 100 / max ))
            local progress=$(( percentage * size / 100 ))
            local remainder=$(( size - progress ))
            printf -v bar "%${progress}s" ""
            printf -v remainder "%${remainder}s" ""
            echo "${bar// /‚ñá}${remainder// /‚ñë} ${percentage}%"
          }

          # Determine report type
          if [[ "${{ github.event_name }}" == "schedule" ]] && [[ "${{ github.event.schedule }}" == "10 0 * * 1" ]] || 
             [[ "${{ inputs.force-refresh }}" == "true" ]]; then
            CACHE_BUSTER=$(date +%s)
            REPORT_TYPE="üöÄ WEEKLY RESET"
            HEADER_STYLE=$( (toilet -f future --filter border:metal "DEV STATS" 2>/dev/null || 
                          figlet -f slant "CODE PULSE" | lolcat 2>/dev/null ||
                          echo "WEEKLY CODING REPORT") )
            DATE_RANGE="$(date -d 'last monday' +'%Y-%m-%d') ‚Üí $(date -d 'last sunday' +'%Y-%m-%d')"
            echo "::notice::Full refresh mode activated"
          else
            CACHE_BUSTER="cache"
            REPORT_TYPE="üìà AUTO UPDATE"
            HEADER_STYLE=$( (figlet -f mini "Live Stats" | lolcat 2>/dev/null || echo "CODING STATS") )
            DATE_RANGE="$(date -d '7 days ago' +'%Y-%m-%d') ‚Üí $(date +'%Y-%m-%d')"
          fi

          # Get WakaTime data
          API_URL="https://wakatime.com/api/v1/users/current/stats/last_7_days?api_key=$WAKATIME_API_KEY&cache_buster=$CACHE_BUSTER"
          echo "::group::Fetching WakaTime data"
          curl -sS --retry 3 --retry-delay 2 "$API_URL" > wakatime.json
          echo "::endgroup::"

          # Process data
          total_seconds=$(jq -r '.data.total_seconds // 0' wakatime.json)
          best_day_seconds=$(jq -r '.data.best_day.total_seconds // 0' wakatime.json)
          productivity=$(echo "scale=1; $best_day_seconds * 100 / ($total_seconds + 1)" | bc)
          week_days=$(jq -r '.data.days | length' wakatime.json)
          
          # Generate report
          echo '```text' > stats.md
          echo "$HEADER_STYLE" | (boxes -d parchment 2>/dev/null || cat) >> stats.md
          echo "‚è≥ $REPORT_TYPE ¬ª $DATE_RANGE" >> stats.md
          echo "üîÑ Last sync: $(date +'%Y-%m-%d %H:%M') (MSK)" >> stats.md
          echo "" >> stats.md
          
          # Main stats
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" >> stats.md
          echo "‚ïë            üìä CODING ANALYTICS              ‚ïë" >> stats.md
          echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï¶‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£" >> stats.md
          printf "‚ïë Total Time          ‚ïë %21s ‚ïë\n" "$(jq -r '.data.human_readable_total // "0 secs"' wakatime.json)" >> stats.md
          echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï¨‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£" >> stats.md
          printf "‚ïë Daily Avg           ‚ïë %21s ‚ïë\n" "$(jq -r '.data.human_readable_daily_average // "0 secs"' wakatime.json)" >> stats.md
          echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï¨‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£" >> stats.md
          printf "‚ïë Best Day            ‚ïë %21s ‚ïë\n" "$(jq -r '(.data.best_day.text // "0 secs") + " (" + (.data.best_day.date // "N/A") + ")"' wakatime.json)" >> stats.md
          echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï¨‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£" >> stats.md
          printf "‚ïë Productivity        ‚ïë %21s ‚ïë\n" "$(generate_progress_bar ${productivity%.*} 100 20)" >> stats.md
          echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï¨‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£" >> stats.md
          printf "‚ïë Active Days         ‚ïë %21s ‚ïë\n" "$week_days/7 days" >> stats.md
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï©‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" >> stats.md
          echo "" >> stats.md
          
          # Top technologies with colors
          echo "üåà TOP 5 TECHNOLOGIES" >> stats.md
          jq -r '.data.languages[0:5] | .[]? | "\(.name): \(.text) (\((.percent|floor)*100/100)%)"' wakatime.json | 
          while IFS= read -r line; do
            progress=$(jq -r --arg name "${line%%:*}" '.data.languages[] | select(.name == $name) | .percent | floor' wakatime.json)
            color=$(( 160 + (RANDOM % 40) ))
            printf "\033[38;5;%sm‚ñå %s\n  %s\033[0m\n" "$color" "$line" "$(generate_progress_bar $progress 100 20)"
          done >> stats.md
          echo "" >> stats.md
          
          # Weekly activity
          echo "üìÖ WEEKLY ACTIVITY" >> stats.md
          echo "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê" >> stats.md
          echo "‚îÇ Day   ‚îÇ Coding Time    ‚îÇ Activity Progress    ‚îÇ" >> stats.md
          echo "‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§" >> stats.md
          jq -r '.data.days | to_entries? | .[]? | "\(.key[:3])|\(.value.text)|\(.value.percent|floor)"' wakatime.json | 
          while IFS='|' read -r day text percent; do
            printf "‚îÇ %-5s ‚îÇ %-14s ‚îÇ %-20s ‚îÇ\n" "$day" "$text" "$(generate_progress_bar $percent 100 20)"
          done >> stats.md
          echo "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò" >> stats.md
          echo "" >> stats.md
          
          # Fun fact
          echo "üí° DEV TIP" >> stats.md
          (fortune -s computers programming science education 2>/dev/null || echo "Keep coding!") | 
          (cowsay -f $(ls /usr/share/cowsay/cows/ 2>/dev/null | shuf -n 1) 2>/dev/null || cat) | 
          (lolcat 2>/dev/null || cat) >> stats.md
          echo '```' >> stats.md

          # Update README
          sed -i '/<!--START_SECTION:waka-->/,/<!--END_SECTION:waka-->/{
              /<!--START_SECTION:waka-->/r stats.md
              d
          }' README.md
          
          # Set outputs
          echo "stats-generated=true" >> $GITHUB_OUTPUT

          # Cleanup
          rm -f stats.md wakatime.json /tmp/stats_for_carbon.md
      
      - name: Generate Carbon image
        if: steps.process-stats.outputs.stats-generated == 'true'
        run: |
          if command -v carbon-now &>/dev/null && [ -f stats.md ]; then
            echo "Generating Carbon image..."
            grep -v '```' stats.md > /tmp/stats_for_carbon.md
            # Use --headless flag and disable browser opening
            carbon-now /tmp/stats_for_carbon.md -t one-dark -l /tmp/carbon.png -h --headless
            echo "carbon-image-generated=true" >> $GITHUB_OUTPUT
          else
            echo "carbon-image-generated=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload Carbon Image Artifact
        if: steps.process-stats.outputs.carbon-image-generated == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: wakatime-stats
          path: /tmp/carbon.png
          retention-days: 7

      - name: Commit and push changes
        if: steps.process-stats.outputs.stats-generated == 'true'
        run: |
          if git diff --quiet --exit-code README.md; then
            echo "::notice::–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ README.md"
            exit 0
          fi

          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add README.md
          
          if [[ "${{ github.event_name }}" == "schedule" ]] && [[ "${{ github.event.schedule }}" == "10 0 * * 1" ]] || 
             [[ "${{ inputs.force-refresh }}" == "true" ]]; then
            git commit -m "üöÄ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ–¥–µ–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ [$(date +'%Y-%m-%d')]" \
                       -m "–ù–∞—á–∞–ª–æ –Ω–æ–≤–æ–π –Ω–µ–¥–µ–ª–∏ | Cache buster: $(date +%s)"
          else
            git commit -m "üìà –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ [$(date +'%H:%M MSK')]" \
                       -m "–ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ | –¢—Ä–∏–≥–≥–µ—Ä: ${{ github.event_name }}"
          fi
          
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git pull --rebase
          git push origin main
