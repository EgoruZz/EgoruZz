name: WakaTime Sync
concurrency:
  group: wakatime-sync-${{ github.ref }}
  cancel-in-progress: false

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:
    inputs:
      force-refresh:
        description: 'Force full refresh (ignore cache)'
        required: false
        default: 'false'

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup environment
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc

      - name: Fetch and process stats
        id: process-stats
        env:
          WAKATIME_API_KEY: ${{ secrets.WAKATIME_API_KEY }}
        run: |
          # Get WakaTime data
          API_URL="https://wakatime.com/api/v1/users/current/stats/last_7_days?api_key=$WAKATIME_API_KEY"
          echo "::group::Fetching WakaTime data"
          curl -sS --retry 3 --retry-delay 2 "$API_URL" > wakatime.json
          echo "::endgroup::"

          # Process data
          total_seconds=$(jq -r '.data.total_seconds // 0' wakatime.json)
          total_time=$(jq -r '.data.human_readable_total // "0 secs"' wakatime.json)
          daily_avg=$(jq -r '.data.human_readable_daily_average // "0 secs"' wakatime.json)
          best_day=$(jq -r '.data.best_day.text // "0 secs"' wakatime.json)
          best_day_date=$(jq -r '.data.best_day.date // ""' wakatime.json)
          languages=$(jq -r '.data.languages[0].name // "None"' wakatime.json)
          editors=$(jq -r '.data.editors[0].name // "None"' wakatime.json)
          operating_systems=$(jq -r '.data.operating_systems[0].name // "None"' wakatime.json)
          
          # Generate report in pure markdown
          echo "<!--START_SECTION:waka-->" >> stats.md
          echo "**â³ Last 7 Days:** $(date -d '6 days ago' +'%Y-%m-%d') â†’ $(date +'%Y-%m-%d')" >> stats.md
          echo "**ðŸ”„ Updated:** $(date +'%Y-%m-%d %H:%M') (MSK) - This shows when this workflow last ran and updated the stats" >> stats.md
          echo "" >> stats.md
          
          # Coding statistics
          echo "### ðŸ“Š Coding Statistics" >> stats.md
          echo "- **Total Time:** $total_time" >> stats.md
          echo "- **Daily Average:** $daily_avg" >> stats.md
          echo "- **Best Day:** $best_day on $best_day_date" >> stats.md
          echo "- **Most Used Editor:** $editors" >> stats.md
          echo "- **Operating System:** $operating_systems" >> stats.md
          echo "" >> stats.md
          
          # Top Languages
          echo "### ðŸš€ Top Languages" >> stats.md
          jq -r '.data.languages[0:10] | .[] | "- \(.name): \(.text) (\(.percent)%)"' wakatime.json 2>/dev/null >> stats.md
          echo "" >> stats.md
          
          # Top Editors
          echo "### âŒ¨ï¸ Top Editors" >> stats.md
          jq -r '.data.editors[0:5] | .[] | "- \(.name): \(.text) (\(.percent)%)"' wakatime.json 2>/dev/null >> stats.md
          echo "" >> stats.md
          
          # Top Operating Systems
          echo "### ðŸ’» Top Operating Systems" >> stats.md
          jq -r '.data.operating_systems[0:3] | .[] | "- \(.name): \(.text) (\(.percent)%)"' wakatime.json 2>/dev/null >> stats.md
          echo "" >> stats.md
          
          # Top Categories
          echo "### ðŸ—‚ï¸ Top Categories" >> stats.md
          jq -r '.data.categories[0:5] | .[] | "- \(.name): \(.text) (\(.percent)%)"' wakatime.json 2>/dev/null >> stats.md
          echo "" >> stats.md
          
          # Code Analytics
          echo "### ðŸ” Code Analytics" >> stats.md
          echo "- **Lines of Code:** $(jq -r '.data.human_readable_total_including_other_language // "N/A"' wakatime.json)" >> stats.md
          echo "- **Most Productive Time:** $best_day on $best_day_date" >> stats.md
          echo "- **Most Used Language:** $languages" >> stats.md
          echo "- **Most Used Editor:** $editors" >> stats.md
          echo "- **Most Used OS:** $operating_systems" >> stats.md
          echo "<!--END_SECTION:waka-->" >> stats.md

          # Update README
          sed -i '/<!--START_SECTION:waka-->/,/<!--END_SECTION:waka-->/{
              /<!--START_SECTION:waka-->/r stats.md
              d
          }' README.md
          
          echo "stats-generated=true" >> $GITHUB_OUTPUT
          rm -f stats.md wakatime.json

      - name: Commit and push changes
        if: steps.process-stats.outputs.stats-generated == 'true'
        run: |
          if git diff --quiet --exit-code README.md; then
            echo "::notice::No changes detected in README.md"
            exit 0
          fi

          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add README.md
          git commit -m "ðŸ“Š Update WakaTime stats [$(date +'%Y-%m-%d %H:%M')]"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git pull --rebase
          git push origin main
