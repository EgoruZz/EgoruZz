name: WakaTime Sync
on:
  schedule:
    - cron: "0 0 * * 1"  # –û—Å–Ω–æ–≤–Ω–æ–π —Å–±—Ä–æ—Å –≤ 00:00 UTC (03:00 –ú–°–ö) –∫–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
    - cron: "0 */3 * * *"  # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 3 —á–∞—Å–∞
  workflow_dispatch:

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc figlet toilet
          sudo npm install -g cowsay
      
      - name: Fetch and process stats
        env:
          WAKATIME_API_KEY: ${{ secrets.WAKATIME_API_KEY }}
        run: |
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∑–∞–ø—Ä–æ—Å–∞
          if [ "$(date +%u)" -eq 1 ] && [ "$(date +%H)" -eq 0 ]; then
            CACHE_BUSTER=$(date +%Y%m%d)
            REPORT_TYPE="WEEKLY REPORT"
            HEADER_STYLE="$(toilet -f term -F border --gay 'DEV STATS')"
          else
            CACHE_BUSTER="cache"
            REPORT_TYPE="AUTO UPDATE"
            HEADER_STYLE="$(figlet -f slant 'Code Pulse')"
          fi

          # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
          curl -s "https://wakatime.com/api/v1/users/current/stats/last_7_days?api_key=$WAKATIME_API_KEY&cache_buster=$CACHE_BUSTER" > wakatime.json
          
          # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
          total_seconds=$(jq -r '.data.total_seconds' wakatime.json)
          best_day_seconds=$(jq -r '.data.best_day.total_seconds' wakatime.json)
          productivity=$(echo "scale=1; $best_day_seconds / $total_seconds * 100" | bc)
          start_date=$(date -d "last monday" +"%Y-%m-%d")
          end_date=$(date -d "last sunday" +"%Y-%m-%d")
          
          # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ASCII-–≥—Ä–∞—Ñ–∏–∫–æ–≤
          generate_bar() {
            local percent=$1
            local bar=""
            for ((i=0; i<10; i++)); do
              if [ $i -lt $(($percent/10)) ]; then
                bar+="‚ñì"
              else
                bar+="‚ñë"
              fi
            done
            echo "$bar $percent%"
          }

          # –§–æ—Ä–º–∏—Ä—É–µ–º Markdown
          echo '```text' > stats.md
          echo "$HEADER_STYLE" >> stats.md
          echo "‚è≥ $REPORT_TYPE ¬ª $start_date ‚Üí $end_date" >> stats.md
          echo "üîÑ Last sync: $(date +"%Y-%m-%d %H:%M") (MSK)" >> stats.md
          echo "" >> stats.md
          
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" >> stats.md
          echo "‚ïë          üöÄ WEEKLY CODING REPORT         ‚ïë" >> stats.md
          echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï¶‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£" >> stats.md
          printf "‚ïë Total Time        ‚ïë %19s ‚ïë\n" "$(jq -r '.data.human_readable_total' wakatime.json)" >> stats.md
          echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï¨‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£" >> stats.md
          printf "‚ïë Daily Avg         ‚ïë %19s ‚ïë\n" "$(jq -r '.data.human_readable_daily_average' wakatime.json)" >> stats.md
          echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï¨‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£" >> stats.md
          printf "‚ïë Best Day          ‚ïë %19s ‚ïë\n" "$(jq -r '.data.best_day.text' wakatime.json)" >> stats.md
          echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï¨‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£" >> stats.md
          printf "‚ïë Productivity Peak ‚ïë %19s ‚ïë\n" "$(generate_bar ${productivity%.*})" >> stats.md
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï©‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" >> stats.md
          echo "" >> stats.md
          
          echo "üî• TOP 5 TECHNOLOGIES" >> stats.md
          jq -r '.data.languages[0:5] | .[] | "‚ñå \(.name): \(.text) \((.percent|floor)*100/100)%\n  \((generate_bar (.percent|floor)))"' wakatime.json >> stats.md
          echo "" >> stats.md
          
          echo "üìÖ WEEKLY ACTIVITY" >> stats.md
          echo "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê" >> stats.md
          echo "‚îÇ Day   ‚îÇ Coding Time  ‚îÇ Activity Graph   ‚îÇ" >> stats.md
          echo "‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§" >> stats.md
          jq -r '.data.days | to_entries | .[] | "‚îÇ \(.key[:3])   ‚îÇ \(.value.text) ‚îÇ \(generate_bar (.value.percent|floor)) ‚îÇ"' wakatime.json >> stats.md
          echo "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò" >> stats.md
          echo "" >> stats.md
          
          # –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω—ã–π ASCII-–∞—Ä—Ç
          ascii_art=("$(cowsay 'Keep coding!' 2>/dev/null)" "$(fortune | cowsay 2>/dev/null)")
          echo "${ascii_art[$RANDOM % ${#ascii_art[@]}]}" >> stats.md
          echo '```' >> stats.md
          
          # –û–±–Ω–æ–≤–ª—è–µ–º README
          sed -i '/<!--START_SECTION:waka-->/,/<!--END_SECTION:waka-->/{
              /<!--START_SECTION:waka-->/r stats.md
              d
          }' README.md
          
          rm -f stats.md wakatime.json
      
      - name: Commit and push changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add README.md
          
          if [ "$(date +%u)" -eq 1 ] && [ "$(date +%H)" -eq 0 ]; then
            git commit -m "üöÄ Weekly stats refresh ($(date +'%Y-%m-%d'))"
          else
            git commit -m "üìä Stats auto-update ($(date +'%H:%M'))" || echo "No changes to commit"
          fi
          
          git push
