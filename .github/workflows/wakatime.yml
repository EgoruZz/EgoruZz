name: WakaTime Sync
concurrency:
  group: wakatime-sync-${{ github.ref }}
  cancel-in-progress: false

on:
  schedule:
    - cron: "0 0 * * *"  # Every day at 00:00 UTC (03:00 MSK)
  workflow_dispatch:
    inputs:
      force-refresh:
        description: 'Force full refresh (ignore cache)'
        required: false
        default: 'false'

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup environment
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc toilet figlet lolcat || echo "Some decorative packages not installed"

      - name: Fetch and process stats
        id: process-stats
        env:
          WAKATIME_API_KEY: ${{ secrets.WAKATIME_API_KEY }}
        run: |
          # Function for progress bars
          generate_progress_bar() {
            local value=${1:-0}
            local max=${2:-100}
            local size=${3:-20}
            local percentage=$(( value * 100 / max ))
            local progress=$(( percentage * size / 100 ))
            local remainder=$(( size - progress ))
            printf -v bar "%${progress}s" ""
            printf -v remainder "%${remainder}s" ""
            echo "${bar// /â–‡}${remainder// /â–‘} ${percentage}%"
          }

          # Determine current week dates (Monday to Sunday)
          MONDAY=$(date -d "monday -1 week" +'%Y-%m-%d')
          SUNDAY=$(date -d "sunday" +'%Y-%m-%d')
          CACHE_BUSTER="cache"
          HEADER_STYLE=$( (figlet -f mini "Live Stats" | lolcat 2>/dev/null || echo "CODING STATS") )
          DATE_RANGE="$MONDAY â†’ $SUNDAY"
          
          # Get WakaTime data for current week
          API_URL="https://wakatime.com/api/v1/users/current/summaries?api_key=$WAKATIME_API_KEY&start=$MONDAY&end=$SUNDAY"
          echo "::group::Fetching WakaTime data"
          curl -sS --retry 3 --retry-delay 2 "$API_URL" > wakatime.json
          echo "::endgroup::"

          # Check if response is valid
          if ! jq -e '.data' wakatime.json >/dev/null 2>&1; then
            echo "::error::Invalid WakaTime API response"
            echo '```text' > stats.md
            echo "â³ WAKATIME STATS UNAVAILABLE" >> stats.md
            echo "ðŸ”„ Last sync attempt: $(date +'%Y-%m-%d %H:%M') (MSK)" >> stats.md
            echo "" >> stats.md
            echo "Failed to fetch data from WakaTime API" >> stats.md
            echo "Please check your API key and connection" >> stats.md
            echo '```' >> stats.md
          else
            # Process data with fallback values
            total_seconds=$(jq -r '[.data[].grand_total.total_seconds] | add // 0' wakatime.json)
            total_time=$(($total_seconds / 3600))h$((($total_seconds % 3600) / 60))m
            daily_avg_seconds=$(($total_seconds / 7))
            daily_avg=$(($daily_avg_seconds / 3600))h$((($daily_avg_seconds % 3600) / 60))m
            
            # Generate report
            echo '```text' > stats.md
            echo "$HEADER_STYLE" >> stats.md
            echo "â³ CURRENT WEEK Â» $DATE_RANGE" >> stats.md
            echo "ðŸ”„ Updated: $(date +'%Y-%m-%d %H:%M') (MSK)" >> stats.md
            echo "" >> stats.md
            
            # Simple metrics table
            echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" >> stats.md
            echo "â”‚ Metric               â”‚ Value            â”‚" >> stats.md
            echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤" >> stats.md
            printf "â”‚ %-20s â”‚ %-16s â”‚\n" "Total Time" "$total_time" >> stats.md
            printf "â”‚ %-20s â”‚ %-16s â”‚\n" "Daily Average" "$daily_avg" >> stats.md
            printf "â”‚ %-20s â”‚ %-16s â”‚\n" "Current Day" "$(date +'%A')" >> stats.md
            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" >> stats.md
            echo "" >> stats.md
            
            # Weekly activity
            if jq -e '.data[].days' wakatime.json >/dev/null 2>&1; then
              echo "ðŸ“… DAILY BREAKDOWN" >> stats.md
              echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" >> stats.md
              echo "â”‚ Day          â”‚ Coding Time    â”‚ Activity Progress    â”‚" >> stats.md
              echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤" >> stats.md
              
              # Combine days from all summaries
              jq -r '.data[].days[] | "\(.date)|\(.text)|\(.total_seconds)"' wakatime.json > days.txt
              
              # Calculate percentages
              total_week_seconds=$(awk -F'|' '{sum += $3} END {print sum}' days.txt)
              
              # Process each day
              while IFS='|' read -r date text seconds; do
                day_name=$(date -d "$date" +"%A")
                if [ "$total_week_seconds" -gt 0 ]; then
                  percent=$((seconds * 100 / total_week_seconds))
                else
                  percent=0
                fi
                printf "â”‚ %-12s â”‚ %-14s â”‚ %-20s â”‚\n" "$day_name" "$text" "$(generate_progress_bar $percent 100 20)"
              done < days.txt >> stats.md
              
              echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" >> stats.md
              rm -f days.txt
            else
              echo "No daily activity data available" >> stats.md
            fi
            echo '```' >> stats.md
          fi

          # Update README
          sed -i '/<!--START_SECTION:waka-->/,/<!--END_SECTION:waka-->/{
              /<!--START_SECTION:waka-->/r stats.md
              d
          }' README.md
          
          # Set outputs
          echo "stats-generated=true" >> $GITHUB_OUTPUT
          rm -f stats.md wakatime.json

      - name: Commit and push changes
        if: steps.process-stats.outputs.stats-generated == 'true'
        run: |
          if git diff --quiet --exit-code README.md; then
            echo "::notice::No changes detected in README.md"
            exit 0
          fi

          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add README.md
          git commit -m "ðŸ“Š Update WakaTime stats [$(date +'%Y-%m-%d %H:%M')]"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git pull --rebase
          git push origin main
