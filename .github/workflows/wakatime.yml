name: WakaTime Sync
concurrency:
  group: waka-sync-${{ github.ref }}
  cancel-in-progress: false

on:
  schedule:
    - cron: "30 0 * * *"
  workflow_dispatch:
    inputs:
      force-refresh:
        description: 'Force full refresh (ignore cache)'
        required: false
        default: 'false'

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup environment
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc

      - name: Fetch and process stats
        id: process-stats
        env:
          WAKATIME_API_KEY: ${{ secrets.WAKATIME_API_KEY }}
        run: |
          # Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð¿Ñ€ÐµÐ¾Ð±Ñ€Ð°Ð·Ð¾Ð²Ð°Ð½Ð¸Ñ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð² Ð¼Ð¸Ð½ÑƒÑ‚Ñ‹
          convert_to_minutes() {
            local time_str="$1"
            if [[ $time_str == *"hrs"* && $time_str == *"mins"* ]]; then
              hours=$(echo "$time_str" | awk '{print $1}')
              minutes=$(echo "$time_str" | awk '{print $3}')
              echo $((hours * 60 + minutes))
            elif [[ $time_str == *"hrs"* ]]; then
              hours=$(echo "$time_str" | awk '{print $1}')
              echo $((hours * 60))
            elif [[ $time_str == *"mins"* ]]; then
              minutes=$(echo "$time_str" | awk '{print $1}')
              echo "$minutes"
            else
              echo 0
            fi
          }

          generate_progress_bar() {
            local minutes=$1
            local max=$2
            local length=10
            local percent=$((minutes * 100 / max))
            percent=$((percent > 100 ? 100 : percent))

            local filled=$((percent * length / 100))
            local empty=$((length - filled))

            filled=$((filled < 0 ? 0 : filled))
            empty=$((empty < 0 ? 0 : empty))

            printf "["
            printf "â–°%.0s" $(seq 1 $filled)
            printf "â–±%.0s" $(seq 1 $empty)
            printf "] %3d%%" "$percent"
          }

          # ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ… WakaTime
          API_URL="https://wakatime.com/api/v1/users/current/stats/last_7_days?api_key=$WAKATIME_API_KEY"
          echo "::group::Fetching WakaTime data"
          curl -sS --retry 3 --retry-delay 2 "$API_URL" > wakatime.json
          echo "::endgroup::"

          # ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ…
          total_seconds=$(jq -r '.data.total_seconds // 0' wakatime.json)
          daily_avg=$(jq -r '.data.human_readable_daily_average // "0 secs"' wakatime.json)
          best_day=$(jq -r '.data.best_day.text // "0 secs"' wakatime.json)
          best_day_date=$(jq -r '.data.best_day.date // ""' wakatime.json)
          languages=$(jq -r '.data.languages[0].name // "None"' wakatime.json)
          os=$(jq -r '.data.operating_systems[0].name // "None"' wakatime.json)
          categories=$(jq -r '.data.categories[0].name // "None"' wakatime.json)
          editors=$(jq -r '.data.editors[0].name // "None"' wakatime.json)
          
          # ÐšÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð°Ñ†Ð¸Ñ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð² Ð¼Ð¸Ð½ÑƒÑ‚Ñ‹
          daily_minutes=$(convert_to_minutes "$daily_avg")
          best_day_minutes=$(convert_to_minutes "$best_day")
          total_minutes=$(convert_to_minutes "$(jq -r '.data.human_readable_total // "0 secs"' wakatime.json)")

          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð·Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 2 Ð´Ð½Ñ Ð´Ð»Ñ ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ñ
          yesterday=$(date -d 'yesterday' +"%Y-%m-%d")
          day_before=$(date -d '2 days ago' +"%Y-%m-%d")

          yesterday_data=$(curl -sS "https://wakatime.com/api/v1/users/current/summaries?api_key=$WAKATIME_API_KEY&start=$yesterday&end=$yesterday" | jq '.data[0]')
          day_before_data=$(curl -sS "https://wakatime.com/api/v1/users/current/summaries?api_key=$WAKATIME_API_KEY&start=$day_before&end=$day_before" | jq '.data[0]')

          yesterday_time=$(echo "$yesterday_data" | jq -r '.grand_total.human_readable_total // "0 mins"')
          day_before_time=$(echo "$day_before_data" | jq -r '.grand_total.human_readable_total // "0 mins"')

          # Ð¡Ñ€Ð°Ð²Ð½Ð¸Ð²Ð°ÐµÐ¼
          yesterday_mins=$(convert_to_minutes "$yesterday_time")
          day_before_mins=$(convert_to_minutes "$day_before_time")

          if (( day_before_mins > 0 )); then
            change_percent=$(( (yesterday_mins - day_before_mins) * 100 / day_before_mins ))
            if (( change_percent > 5 )); then
              trend="â–² $change_percent%"
            elif (( change_percent < -5 )); then
              trend="â–¼ $((change_percent * -1))%"
            else
              trend="â‰ˆ"
            fi
          else
            trend="N/A"
          fi

          # Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ð°
          echo "<!--START_SECTION:waka-->" > stats.md
          echo "<div align='center'>" >> stats.md
          echo "" >> stats.md
          echo "## â³ WakaTime Weekly Report" >> stats.md
          echo "" >> stats.md
          
          # Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾Ð± Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ðµ
          echo "### ðŸ“Œ Report Info" >> stats.md
          echo "" >> stats.md
          echo "| Period | Range |" >> stats.md
          echo "|--------|-------|" >> stats.md
          echo "| Last 7 Days | $(date -d '7 days ago' +'%Y-%m-%d') â†’ $(date -d 'yesterday' +'%Y-%m-%d') |" >> stats.md
          echo "| Last Updated | $(date -u +'%Y-%m-%d %H:%M') UTC |" >> stats.md
          echo "" >> stats.md
          
          # Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° ÐºÐ¾Ð´Ð¸Ð½Ð³Ð°
          echo "### ðŸ“Š Coding Statistics" >> stats.md
          echo "" >> stats.md
          echo "| Metric | Value | Progress |" >> stats.md
          echo "|--------|-------|----------|" >> stats.md
          printf "| Daily Average | %s | %s |\n" "$daily_avg" "$(generate_progress_bar $daily_minutes 1440)" >> stats.md
          printf "| Best Day | %s on %s | %s |\n" "$best_day" "$best_day_date" "$(generate_progress_bar $best_day_minutes 1440)" >> stats.md
          printf "| Total Time | %s (per week) | %s |\n" "$(jq -r '.data.human_readable_total // "0 secs"' wakatime.json)" "$(generate_progress_bar $total_minutes 10080)" >> stats.md
          echo "" >> stats.md
          
          # Ð¡Ñ€Ð°Ð²Ð½ÐµÐ½Ð¸Ðµ Ð´Ð½ÐµÐ¹ (Ð½Ð¾Ð²Ð°Ñ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ð°Ñ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð°)
          echo "### ðŸ”„ Daily Comparison" >> stats.md
          echo "" >> stats.md
          echo "| Day | Time | Progress | Trend |" >> stats.md
          echo "|-----|------|----------|-------|" >> stats.md
          printf "| %s | %s | %s | %s |\n" "$(date -d '2 days ago' +'%a, %b %d')" "$day_before_time" "$(generate_progress_bar $day_before_mins 1440)" "Baseline" >> stats.md
          printf "| %s | %s | %s | %s |\n" "$(date -d 'yesterday' +'%a, %b %d')" "$yesterday_time" "$(generate_progress_bar $yesterday_mins 1440)" "$trend" >> stats.md
          echo "" >> stats.md
          
          # Ð¢Ð¾Ð¿ ÑÐ·Ñ‹ÐºÐ¾Ð²
          echo "### ðŸš€ Top Languages" >> stats.md
          echo "" >> stats.md
          echo "| Language | Time | Usage |" >> stats.md
          echo "|----------|------|-------|" >> stats.md
          jq -r '.data.languages[0:5] | .[] | "\(.name)|\(.text)|\(.percent)"' wakatime.json 2>/dev/null | while IFS='|' read -r name text percent; do
            lang_minutes=$(convert_to_minutes "$text")
            printf "| %s | %s | %s |\n" "$name" "$text" "$(generate_progress_bar $lang_minutes 1440)" >> stats.md
          done
          echo "" >> stats.md
          
          # Ð˜Ð½ÑÐ°Ð¹Ñ‚Ñ‹
          echo "### ðŸ” Code Insights" >> stats.md
          echo "" >> stats.md
          echo "| Insight | Value |" >> stats.md
          echo "|---------|-------|" >> stats.md
          echo "| ðŸ’Ž Top Language | $languages |" >> stats.md
          echo "| ðŸ–¥ï¸ OS | $os |" >> stats.md
          echo "| âŒ¨ï¸ Editor | $editors |" >> stats.md
          echo "| ðŸ“Š Category | $categories |" >> stats.md
          echo "" >> stats.md
          
          echo "</div>" >> stats.md
          echo "<!--END_SECTION:waka-->" >> stats.md

          # ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ README
          sed -i '/<!--START_SECTION:waka-->/,/<!--END_SECTION:waka-->/{
              /<!--START_SECTION:waka-->/r stats.md
              d
          }' README.md
          
          echo "stats-generated=true" >> $GITHUB_OUTPUT
          rm -f stats.md wakatime.json

      - name: Commit and push changes
        if: steps.process-stats.outputs.stats-generated == 'true'
        run: |
          if git diff --quiet --exit-code README.md; then
            echo "::notice::No changes detected in README.md"
            exit 0
          fi

          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add README.md
          git commit -m "ðŸ“Š Update WakaTime stats [$(date +'%Y-%m-%d %H:%M')]"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git pull --rebase
          git push origin main
