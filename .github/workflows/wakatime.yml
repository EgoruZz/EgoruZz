name: WakaTime Sync
concurrency:
  group: wakatime-sync-${{ github.ref }}
  cancel-in-progress: false

on:
  schedule:
    - cron: "10 0 * * 1"  # ÐŸÐ¾Ð½ÐµÐ´ÐµÐ»ÑŒÐ½Ð¸Ðº Ð² 00:10 UTC (03:10 ÐœÐ¡Ðš)
    - cron: "0 */3 * * *" # ÐšÐ°Ð¶Ð´Ñ‹Ðµ 3 Ñ‡Ð°ÑÐ° Ð² :00
  workflow_dispatch:
    inputs:
      force-refresh:
        description: 'Force full refresh (ignore cache)'
        required: false
        default: 'false'

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup environment
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc figlet toilet boxes
          sudo npm install -g carbon-now-cli || echo "Carbon-now-cli installation failed"
          command -v cowsay >/dev/null 2>&1 || sudo apt-get install -y cowsay
          command -v fortune >/dev/null 2>&1 || sudo apt-get install -y fortune-mod
          command -v lolcat >/dev/null 2>&1 || sudo gem install lolcat || echo "Lolcat not available"

      - name: Fetch and process stats
        id: stats
        env:
          WAKATIME_API_KEY: ${{ secrets.WAKATIME_API_KEY }}
        run: |
          # Ð£Ð»ÑƒÑ‡ÑˆÐµÐ½Ð½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð³Ñ€Ð°Ñ„Ð¸ÐºÐ¾Ð²
          generate_progress_bar() {
            local value=${1:-0}
            local max=${2:-100}
            local size=${3:-20}
            local percentage=$(( value * 100 / max ))
            local progress=$(( percentage * size / 100 ))
            local remainder=$(( size - progress ))
            printf -v bar "%${progress}s" ""
            printf -v remainder "%${remainder}s" ""
            echo "${bar// /â–‡}${remainder// /â–‘} ${percentage}%"
          }

          # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ñ‚Ð¸Ð¿Ð° Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°
          if [[ "${{ github.event_name }}" == "schedule" && "${{ github.event.schedule }}" == "10 0 * * 1" ]] || 
             [[ "${{ inputs.force-refresh }}" == "true" ]]; then
            CACHE_BUSTER=$(date +%s)
            REPORT_TYPE="ðŸš€ WEEKLY RESET"
            HEADER_STYLE=$(toilet -f future --filter border:metal "DEV STATS" 2>/dev/null || 
                          figlet -f slant "CODE PULSE" | lolcat 2>/dev/null ||
                          echo "WEEKLY CODING REPORT")
            DATE_RANGE="$(date -d 'last monday' +'%Y-%m-%d') â†’ $(date -d 'last sunday' +'%Y-%m-%d')"
            echo "::notice::Full refresh mode activated"
          else
            CACHE_BUSTER="cache"
            REPORT_TYPE="ðŸ“ˆ AUTO UPDATE"
            HEADER_STYLE=$(figlet -f mini "Live Stats" | lolcat 2>/dev/null || echo "CODING STATS")
            DATE_RANGE="$(date -d '7 days ago' +'%Y-%m-%d') â†’ $(date +'%Y-%m-%d')"
          fi

          # ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ñ ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð½Ð¾Ð¹ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¾Ð¹ Ð¾ÑˆÐ¸Ð±Ð¾Ðº
          API_URL="https://wakatime.com/api/v1/users/current/stats/last_7_days?api_key=$WAKATIME_API_KEY&cache_buster=$CACHE_BUSTER"
          echo "::group::Fetching WakaTime data"
          curl -sS --retry 3 --retry-delay 2 "$API_URL" > wakatime.json
          HTTP_CODE=$(curl -s -o /dev/null -w '%{http_code}' "$API_URL")
          echo "HTTP Status: $HTTP_CODE"
          echo "::endgroup::"

          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ…
          if ! jq -e '.data' wakatime.json >/dev/null 2>&1; then
            echo "::error::Invalid WakaTime API response"
            ERROR_MSG=$(jq -r '.message // empty' wakatime.json 2>/dev/null || echo "Unknown error")
            
            echo '```text' > stats.md
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" >> stats.md
            echo "â•‘        âš ï¸ API ERROR           â•‘" >> stats.md
            echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" >> stats.md
            echo "â•‘ $REPORT_TYPE Â» $DATE_RANGE    â•‘" >> stats.md
            echo "â•‘                                â•‘" >> stats.md
            echo "â•‘ HTTP: $HTTP_CODE               â•‘" >> stats.md
            echo "â•‘ Error: $ERROR_MSG              â•‘" >> stats.md
            echo "â•‘                                â•‘" >> stats.md
            echo "â•‘ Last sync attempt:             â•‘" >> stats.md
            echo "â•‘ $(date +'%Y-%m-%d %H:%M MSK') â•‘" >> stats.md
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> stats.md
            echo '```' >> stats.md
          else
            # ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ…
            total_seconds=$(jq -r '.data.total_seconds // 0' wakatime.json)
            best_day_seconds=$(jq -r '.data.best_day.total_seconds // 0' wakatime.json)
            productivity=$(echo "scale=1; $best_day_seconds * 100 / ($total_seconds + 1)" | bc)
            week_days=$(jq -r '.data.days | length' wakatime.json)
            
            # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°
            echo '```text' > stats.md
            echo "$HEADER_STYLE" | boxes -d parchment 2>/dev/null >> stats.md || echo "$HEADER_STYLE" >> stats.md
            echo "â³ $REPORT_TYPE Â» $DATE_RANGE" >> stats.md
            echo "ðŸ”„ Last sync: $(date +'%Y-%m-%d %H:%M') (MSK)" >> stats.md
            echo "" >> stats.md
            
            # ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" >> stats.md
            echo "â•‘            ðŸ“Š CODING ANALYTICS              â•‘" >> stats.md
            echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" >> stats.md
            printf "â•‘ Total Time          â•‘ %21s â•‘\n" "$(jq -r '.data.human_readable_total // "0 secs"' wakatime.json)" >> stats.md
            echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" >> stats.md
            printf "â•‘ Daily Avg           â•‘ %21s â•‘\n" "$(jq -r '.data.human_readable_daily_average // "0 secs"' wakatime.json)" >> stats.md
            echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" >> stats.md
            printf "â•‘ Best Day            â•‘ %21s â•‘\n" "$(jq -r '(.data.best_day.text // "0 secs") + " (" + (.data.best_day.date // "N/A") + ")"" wakatime.json)" >> stats.md
            echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" >> stats.md
            printf "â•‘ Productivity        â•‘ %21s â•‘\n" "$(generate_progress_bar ${productivity%.*} 100 20)" >> stats.md
            echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" >> stats.md
            printf "â•‘ Active Days         â•‘ %21s â•‘\n" "$week_days/7 days" >> stats.md
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> stats.md
            echo "" >> stats.md
            
            # Ð¢Ð¾Ð¿ Ñ‚ÐµÑ…Ð½Ð¾Ð»Ð¾Ð³Ð¸Ð¸ Ñ Ñ†Ð²ÐµÑ‚Ð°Ð¼Ð¸
            echo "ðŸŒˆ TOP 5 TECHNOLOGIES" >> stats.md
            jq -r '.data.languages[0:5] | .[]? | "â–Œ \(.name): \(.text) \((.percent|floor)*100/100)%\n  \((generate_progress_bar (.percent|floor) 100 20))"' wakatime.json | 
            awk '{print "\033[38;5;" (NR+160) "m" $0 "\033[0m"}' | 
            ansi2txt >> stats.md
            echo "" >> stats.md
            
            # Ð•Ð¶ÐµÐ½ÐµÐ´ÐµÐ»ÑŒÐ½Ð°Ñ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒ
            echo "ðŸ“… WEEKLY ACTIVITY" >> stats.md
            echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" >> stats.md
            echo "â”‚ Day   â”‚ Coding Time    â”‚ Activity Progress    â”‚" >> stats.md
            echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤" >> stats.md
            jq -r '.data.days | to_entries? | .[]? | "â”‚ \(.key[:3])   â”‚ \(.value.text) â”‚ \(generate_progress_bar (.value.percent|floor) 100 20) â”‚"' wakatime.json >> stats.md
            echo "â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" >> stats.md
            echo "" >> stats.md
            
            # Ð˜Ð½Ñ‚ÐµÑ€ÐµÑÐ½Ñ‹Ðµ Ñ„Ð°ÐºÑ‚Ñ‹
            echo "ðŸ’¡ DEV TIP" >> stats.md
            fortune -s computers programming science education | cowsay -f $(ls /usr/share/cowsay/cows/ | shuf -n 1) | lolcat 2>/dev/null >> stats.md || 
            echo "Today is $(date +'%A'). Keep coding and learning!" >> stats.md
            echo '```' >> stats.md
          fi

          # ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ README
          sed -i '/<!--START_SECTION:waka-->/,/<!--END_SECTION:waka-->/{
              /<!--START_SECTION:waka-->/r stats.md
              d
          }' README.md
          
          # Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ carbon-Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ
          if command -v carbon-now &>/dev/null; then
            carbon-now <(grep -v '```' stats.md) -t one-dark -l /tmp/carbon.png
            echo "CARBON_IMAGE=$(base64 -w0 /tmp/carbon.png)" >> $GITHUB_ENV
          fi
          
          rm -f stats.md wakatime.json /tmp/carbon.png
          echo "stats-generated=true" >> $GITHUB_OUTPUT

      - name: Generate Carbon Image
        id: carbon
        if: steps.stats.outputs.stats-generated == 'true'
        run: |
          if command -v carbon-now &>/dev/null && [ -f stats.md ]; then
            echo "Generating Carbon image..."
            grep -v '```' stats.md > /tmp/stats_for_carbon.md
            carbon-now /tmp/stats_for_carbon.md -t one-dark -l /tmp/carbon.png -h
            
            # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ outputs Ð²Ð¼ÐµÑÑ‚Ð¾ env
            echo "image-generated=true" >> $GITHUB_OUTPUT
            base64 /tmp/carbon.png > /tmp/carbon.txt
          else
            echo "Carbon image generation skipped"
            echo "image-generated=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload Artifact
        if: steps.carbon.outputs.image-generated == 'true'
        uses: actions/upload-artifact@v3
        with:
          name: wakatime-stats
          path: /tmp/carbon.png

      - name: Commit and push changes
        run: |
          if git diff --quiet --exit-code README.md; then
            echo "::notice::No changes detected in README.md"
            exit 0
          fi

          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add README.md
          
          if [[ "${{ github.event_name }}" == "schedule" && "${{ github.event.schedule }}" == "10 0 * * 1" ]] || 
             [[ "${{ inputs.force-refresh }}" == "true" ]]; then
            git commit -m "ðŸš€ Weekly stats reset [$(date +'%Y-%m-%d')]" \
                       -m "Fresh week start | Cache buster: $(date +%s)"
          else
            git commit -m "ðŸ“ˆ Stats auto-update [$(date +'%H:%M MSK')]" \
                       -m "Incremental refresh | Trigger: ${{ github.event_name }}"
          fi
          
          git pull --rebase
          git push
