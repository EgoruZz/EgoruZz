name: WakaTime Weekly Report
on:
  schedule:
    - cron: "0 0 * * 1"  # –ö–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤ 21:00 –ú–°–ö
  workflow_dispatch:

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # –í–∞–∂–Ω–æ –¥–ª—è –ø–æ–ª–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏ git
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc
      
      - name: Fetch weekly stats
        env:
          WAKATIME_API_KEY: ${{ secrets.WAKATIME_API_KEY }}
        run: |
          # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
          curl -s "https://wakatime.com/api/v1/users/current/stats/last_7_days?api_key=$WAKATIME_API_KEY" > wakatime.json
          
          # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
          total_seconds=$(jq -r '.data.total_seconds' wakatime.json)
          best_day_seconds=$(jq -r '.data.best_day.total_seconds' wakatime.json)
          productivity=$(echo "scale=1; $best_day_seconds / $total_seconds * 100" | bc)
          start_date=$(date -d "last monday" +"%Y-%m-%d")
          end_date=$(date -d "last sunday" +"%Y-%m-%d")
          
          # –§–æ—Ä–º–∏—Ä—É–µ–º Markdown
          echo '```text' > stats.md
          echo '‚è≥ WEEKLY REPORT ('$start_date' ‚Üí '$end_date')' >> stats.md
          echo '‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê' >> stats.md
          echo '‚îÇ            üìä CODING ANALYTICS        ‚îÇ' >> stats.md
          echo '‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§' >> stats.md
          echo '‚îÇ Total Time            ‚îÇ '$(jq -r '.data.human_readable_total' wakatime.json)' ‚îÇ' >> stats.md
          echo '‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§' >> stats.md
          echo '‚îÇ Daily Avg             ‚îÇ '$(jq -r '.data.human_readable_daily_average' wakatime.json)' ‚îÇ' >> stats.md
          echo '‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§' >> stats.md
          echo '‚îÇ Best Day              ‚îÇ '$(jq -r '.data.best_day.text + " (" + .data.best_day.date + ")"' wakatime.json)' ‚îÇ' >> stats.md
          echo '‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§' >> stats.md
          echo '‚îÇ Productivity Peak     ‚îÇ '$productivity'% ‚îÇ' >> stats.md
          echo '‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò' >> stats.md
          echo '' >> stats.md
          
          echo 'üîù TOP 5 TECHNOLOGIES' >> stats.md
          jq -r '.data.languages[0:5] | .[] | "‚îÇ \(.name): \(.text) (\(.percent|floor)%)"' wakatime.json >> stats.md
          echo '' >> stats.md
          
          echo 'üìÖ Report generated: '$(date +"%Y-%m-%d %H:%M")' (MSK)' >> stats.md
          echo '```' >> stats.md
          
          # –û–±–Ω–æ–≤–ª—è–µ–º README
          sed -i '/<!--START_SECTION:waka-->/,/<!--END_SECTION:waka-->/{
              /<!--START_SECTION:waka-->/r stats.md
              d
          }' README.md
          
          # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
          rm -f stats.md wakatime.json
      
      - name: Commit and push changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add README.md
          git diff --quiet && git diff --staged --quiet || git commit -m "üìà Weekly WakaTime Report Update"
          git push
