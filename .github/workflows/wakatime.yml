name: WakaTime Sync
concurrency:
  group: wakatime-sync-${{ github.ref }}
  cancel-in-progress: false

on:
  schedule:
    - cron: "10 0 * * 1"  # Monday at 00:10 UTC (03:10 MSK)
    - cron: "0 */3 * * *" # Every 3 hours at :00
  workflow_dispatch:

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Log trigger info
        run: |
          echo "::group::Trigger details"
          echo "Event: ${{ github.event_name }}"
          echo "Schedule: ${{ github.event.schedule || 'Manual' }}"
          echo "UTC Time: $(date -u)"
          echo "::endgroup::"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc figlet toilet
          sudo npm install -g cowsay || sudo apt-get install -y cowsay || echo "Cowsay not available"
          sudo apt-get install -y fortune-mod || echo "Fortune not available"

      - name: Fetch and process stats
        env:
          WAKATIME_API_KEY: ${{ secrets.WAKATIME_API_KEY }}
        run: |
          # Improved bar chart function
          generate_bar() {
            local percent=${1:-0}
            percent=$(( percent < 0 ? 0 : (percent > 100 ? 100 : percent) ))
            local filled=$((percent/10))
            local empty=$((10-filled))
            printf -v bar '%*s' "$filled"
            bar=${bar// /â–“}
            printf -v empty_bar '%*s' "$empty"
            empty_bar=${empty_bar// /â–‘}
            echo "${bar}${empty_bar} $percent%"
          }

          # Determine report type
          if [ "${{ github.event_name }}" = "schedule" ] && [ "${{ github.event.schedule }}" = "10 0 * * 1" ]; then
            CACHE_BUSTER=$(date +%s)
            REPORT_TYPE="ðŸš€ WEEKLY RESET"
            HEADER_STYLE=$(toilet -f term -F border --gay 'WEEKLY RESET' 2>/dev/null || echo 'WEEKLY CODING REPORT')
            DATE_RANGE="$(date -d 'last monday' +'%Y-%m-%d') â†’ $(date -d 'last sunday' +'%Y-%m-%d')"
          else
            CACHE_BUSTER="cache"
            REPORT_TYPE="ðŸ“ˆ AUTO UPDATE"
            HEADER_STYLE=$(figlet -f slant 'Code Pulse' 2>/dev/null || echo 'CODING STATS')
            DATE_RANGE="$(date -d '7 days ago' +'%Y-%m-%d') â†’ $(date +'%Y-%m-%d')"
          fi

          # API request with error handling
          API_URL="https://wakatime.com/api/v1/users/current/stats/last_7_days?api_key=$WAKATIME_API_KEY&cache_buster=$CACHE_BUSTER"
          echo "::group::Fetching WakaTime data"
          response=$(curl -s -w "%{http_code}" "$API_URL")
          http_code=${response: -3}
          json_content=${response%???}
          echo "$json_content" > wakatime.json
          
          if [ "$http_code" != "200" ] || ! jq -e '.data' wakatime.json >/dev/null; then
            echo "::error::WakaTime API request failed (HTTP $http_code)"
            echo '```text' > stats.md
            echo "âš ï¸ WAKATIME API ERROR" >> stats.md
            echo "â³ $REPORT_TYPE Â» $DATE_RANGE" >> stats.md
            echo "ðŸ”„ Last sync attempt: $(date +'%Y-%m-%d %H:%M') (MSK)" >> stats.md
            echo "ðŸ”— Response Code: $http_code" >> stats.md
            echo '```' >> stats.md
          else
            # Process data
            total_seconds=$(jq -r '.data.total_seconds // 0' wakatime.json)
            best_day_seconds=$(jq -r '.data.best_day.total_seconds // 0' wakatime.json)
            productivity=$(echo "scale=1; $best_day_seconds * 100 / ($total_seconds + 1)" | bc)

            # Generate markdown report
            echo '```text' > stats.md
            echo "$HEADER_STYLE" >> stats.md
            echo "â³ $REPORT_TYPE Â» $DATE_RANGE" >> stats.md
            echo "ðŸ”„ Last sync: $(date +'%Y-%m-%d %H:%M') (MSK)" >> stats.md
            echo "" >> stats.md
            
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" >> stats.md
            echo "â•‘          ðŸ“Š CODING ANALYTICS             â•‘" >> stats.md
            echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" >> stats.md
            printf "â•‘ Total Time        â•‘ %19s â•‘\n" "$(jq -r '.data.human_readable_total // "0 secs"' wakatime.json)" >> stats.md
            echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" >> stats.md
            printf "â•‘ Daily Avg         â•‘ %19s â•‘\n" "$(jq -r '.data.human_readable_daily_average // "0 secs"' wakatime.json)" >> stats.md
            echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" >> stats.md
            printf "â•‘ Best Day          â•‘ %19s â•‘\n" "$(jq -r '(.data.best_day.text // "0 secs") + " (" + (.data.best_day.date // "N/A") + ")"" wakatime.json)" >> stats.md
            echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" >> stats.md
            printf "â•‘ Productivity Peak â•‘ %19s â•‘\n" "$(generate_bar ${productivity%.*})" >> stats.md
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> stats.md
            echo "" >> stats.md
            
            echo "ðŸ”¥ TOP 5 TECHNOLOGIES" >> stats.md
            jq -r '.data.languages[0:5] | .[] | "â–Œ \(.name): \(.text) \((.percent|floor)*100/100)%\n  \(.percent | floor | generate_bar)"' wakatime.json >> stats.md
            echo "" >> stats.md
            
            echo "ðŸ“… WEEKLY ACTIVITY" >> stats.md
            echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" >> stats.md
            echo "â”‚ Day   â”‚ Coding Time  â”‚ Activity Graph   â”‚" >> stats.md
            echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤" >> stats.md
            jq -r '.data.days | to_entries | .[] | "â”‚ \(.key[:3])   â”‚ \(.value.text) â”‚ \(.value.percent | floor | generate_bar) â”‚"' wakatime.json >> stats.md
            echo "â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" >> stats.md
            echo "" >> stats.md
            
            # Random ASCII art
            if command -v cowsay &> /dev/null && command -v fortune &> /dev/null; then
              cowsay -f $(ls /usr/share/cowsay/cows | shuf -n 1) "$(fortune -s 2>/dev/null || echo "Keep coding!")" >> stats.md
            else
              echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" >> stats.md
              echo "â”‚ Today is $(date +'%A') - perfect day to code! â”‚" >> stats.md
              echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" >> stats.md
            fi
            echo '```' >> stats.md
          fi

          # Update README
          sed -i '/<!--START_SECTION:waka-->/,/<!--END_SECTION:waka-->/{
              /<!--START_SECTION:waka-->/r stats.md
              d
          }' README.md
          
          rm -f stats.md wakatime.json

      - name: Commit and push changes
        run: |
          if ! git diff --quiet --exit-code README.md; then
            git config --global user.name "GitHub Actions"
            git config --global user.email "actions@github.com"
            git add README.md
            
            if [ "${{ github.event_name }}" = "schedule" ] && [ "${{ github.event.schedule }}" = "10 0 * * 1" ]; then
              git commit -m "ðŸš€ Weekly stats reset [$(date +'%Y-%m-%d')]" \
                         -m "Fresh week start | Cache buster: $(date +%s)"
            else
              git commit -m "ðŸ“ˆ Stats auto-update [$(date +'%H:%M MSK')]" \
                         -m "Incremental refresh | Trigger: ${{ github.event_name }}"
            fi
            
            git pull --rebase
            git push
            echo "::notice::Changes committed successfully"
          else
            echo "::notice::No changes detected in README.md"
          fi
